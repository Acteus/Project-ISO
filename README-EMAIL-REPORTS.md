# Email Reports Configuration Guide

## Overview
The ISO 21001 System uses **Google SMTP** (Gmail) to send email reports, including:
- Weekly Progress Reports
- Monthly Compliance Reports
- Password Reset Emails

All emails are sent using the same SMTP configuration defined in your `.env` file.

## Current Configuration

Your system is configured with the following settings:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=kwadrateam@gmail.com
MAIL_PASSWORD="drgi qjzk njfh sopv"
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="kwadrateam@gmail.com"
MAIL_FROM_NAME="Jose Rizal University"
```

## How It Works

### 1. Google SMTP Settings
- **Host**: `smtp.gmail.com` - Gmail's SMTP server
- **Port**: `587` - Standard port for TLS/STARTTLS
- **Encryption**: `tls` - Secure transmission using TLS
- **From Address**: The email address that appears as the sender
- **From Name**: The display name shown to recipients

### 2. Authentication
The system uses a **Google App Password** for authentication:
- This is NOT your regular Gmail password
- It's a 16-character password generated by Google
- Requires 2-Step Verification to be enabled on your Google account

## Testing Email Configuration

### Option 1: Via Web Interface
1. Go to Admin Dashboard â†’ Reports
2. Click the **"ðŸ“§ Test Email Configuration"** button
3. Enter your email address
4. Click "Send Test Email"
5. Check your inbox (and spam folder) for the test email

### Option 2: Via Command Line
```bash
php artisan email:test your-email@example.com
```

This will:
- Display your current email configuration
- Send a test email to the specified address
- Show success or error messages with troubleshooting tips

## Sending Reports

### Weekly Progress Report
1. Navigate to **Admin Dashboard â†’ Reports**
2. Select a recipient (or enter a custom email)
3. Choose the month and week number
4. Click "Preview Data" (optional) to see the report data
5. Click "Send Report"
6. The report will be sent via Google SMTP

### Monthly Compliance Report
1. Navigate to **Admin Dashboard â†’ Reports**
2. Select a recipient (or enter a custom email)
3. Choose the month
4. Click "Preview Data" (optional) to see the report data
5. Click "Send Report"
6. The report will be sent via Google SMTP

## Email Templates

The system uses Laravel Blade templates for emails:
- **Weekly Report**: `resources/views/emails/weekly-progress-report.blade.php`
- **Monthly Report**: `resources/views/emails/monthly-compliance-report.blade.php`
- **Password Reset**: Laravel's built-in template

## Troubleshooting

### Email Not Received

1. **Check Spam/Junk Folder**
   - Gmail sometimes filters automated emails

2. **Verify SMTP Settings**
   - Ensure `.env` file has correct values
   - Check that `MAIL_MAILER` is set to `smtp`

3. **Check Google Account Settings**
   - Verify 2-Step Verification is enabled
   - Make sure the App Password is still valid
   - Check if Google has blocked the login attempt

4. **View Laravel Logs**
   ```bash
   tail -f storage/logs/laravel.log
   ```
   Look for error messages related to email sending

5. **Test SMTP Connection**
   ```bash
   php artisan email:test your-email@example.com
   ```

### Common Error Messages

#### "Failed to authenticate on SMTP server"
- **Cause**: Incorrect username or password
- **Solution**: 
  - Verify `MAIL_USERNAME` matches your Gmail address
  - Generate a new App Password if needed
  - Remove quotes from password if present (or keep them if password has spaces)

#### "Connection could not be established"
- **Cause**: Network or firewall issues
- **Solution**:
  - Check internet connection
  - Verify port 587 is not blocked by firewall
  - Try using port 465 with SSL encryption instead of TLS

#### "535-5.7.8 Username and Password not accepted"
- **Cause**: App Password not set up correctly
- **Solution**:
  1. Go to Google Account â†’ Security
  2. Enable 2-Step Verification
  3. Generate a new App Password
  4. Update `MAIL_PASSWORD` in `.env`
  5. Run `php artisan config:cache`

## Generating a New Google App Password

1. Go to [Google Account Settings](https://myaccount.google.com/)
2. Click on **Security** in the left sidebar
3. Under "Signing in to Google," click **2-Step Verification**
4. Enable 2-Step Verification if not already enabled
5. Go back to Security â†’ **App passwords**
6. Select **Mail** and **Other (Custom name)**
7. Enter "ISO 21001 System" as the name
8. Click **Generate**
9. Copy the 16-character password
10. Update your `.env` file:
    ```env
    MAIL_PASSWORD="xxxx xxxx xxxx xxxx"
    ```
11. Clear the config cache:
    ```bash
    php artisan config:cache
    ```

## Security Best Practices

1. **Never commit `.env` file to version control**
   - The `.gitignore` file should include `.env`
   - App passwords should remain secret

2. **Use App Passwords, not regular passwords**
   - More secure and can be revoked independently
   - Doesn't expose your main Gmail password

3. **Regularly rotate App Passwords**
   - Generate new passwords periodically
   - Revoke old passwords when no longer needed

4. **Monitor email sending logs**
   - Check `storage/logs/laravel.log` for suspicious activity
   - Set up alerts for failed authentication attempts

## Configuration Files

### `.env`
Contains all email configuration variables. This is the only file you need to edit for email setup.

### `config/mail.php`
Laravel's mail configuration file. It reads from `.env` and sets up the mail system. Usually doesn't need modification.

### Email Controllers
- `app/Http/Controllers/Admin/ReportController.php` - Handles report email sending
- `app/Http/Controllers/Auth/ForgotPasswordController.php` - Handles password reset emails

## Advanced Configuration

### Using a Different Gmail Account

To use a different Gmail account:

1. Update `.env`:
   ```env
   MAIL_USERNAME=new-email@gmail.com
   MAIL_PASSWORD="new app password"
   MAIL_FROM_ADDRESS="new-email@gmail.com"
   ```

2. Generate an App Password for the new account

3. Clear config cache:
   ```bash
   php artisan config:cache
   ```

4. Test the new configuration:
   ```bash
   php artisan email:test your-email@example.com
   ```

### Using a Different SMTP Provider

To use a different SMTP provider (e.g., SendGrid, Mailgun):

1. Update `.env` with the provider's settings:
   ```env
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.provider.com
   MAIL_PORT=587
   MAIL_USERNAME=your-username
   MAIL_PASSWORD=your-password
   MAIL_ENCRYPTION=tls
   ```

2. Clear config cache and test

## Support

If you continue to experience issues:

1. Check the Laravel logs: `storage/logs/laravel.log`
2. Review this documentation
3. Test with the command: `php artisan email:test your-email@example.com`
4. Contact the development team with:
   - Error messages from logs
   - Output from test command
   - Screenshot of any UI errors

## Related Documentation

- [README-EMAIL-AUTHENTICATION.md](README-EMAIL-AUTHENTICATION.md) - Password reset email setup
- [EMAIL-SETUP-GUIDE.md](EMAIL-SETUP-GUIDE.md) - General email setup guide
- [Laravel Mail Documentation](https://laravel.com/docs/mail)

---

**Last Updated**: October 29, 2025  
**System**: ISO 21001 Quality Education Management System  
**Institution**: Jose Rizal University
